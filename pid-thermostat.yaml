blueprint:
  name: PID-thermostat
  description: >
    –ü–ª–∞–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–º–º–µ—Ä–æ–º (–ò–ö-–ª–∞–º–ø–æ–π) –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –≤ —Ç–µ—Ä—Ä–∞—Ä–∏—É–º–µ.

  domain: automation
  input:
    temp_sensor:
      name: –î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
      selector:
        entity:
          domain: sensor
          device_class: temperature

    ir_dimmer:
      name: –î–∏–º–º–µ—Ä (–ò–ö-–ª–∞–º–ø–∞)
      selector:
        entity:
          domain: light

    target_temp:
      name: –£—Å—Ç–∞–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (¬∞C)
      selector:
        entity:
          domain: input_number

    max_temp:
      name: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)
      description: "–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —ç—Ç–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –ª–∞–º–ø–∞ –≤—ã–∫–ª—é—á–∏—Ç—Å—è"
      default: 42
      selector:
        number:
          min: 30
          max: 60
          step: 0.5

    integral_var:
      name: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞–ª–∞ (input_number)
      selector:
        entity:
          domain: input_number

    last_error_var:
      name: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—à–∏–±–∫–∏ (input_number)
      selector:
        entity:
          domain: input_number
    kP:
      name: P-–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç PID
      description: P (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è) - —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Ç–µ–∫—É—â—É—é –æ—à–∏–±–∫—É
      default: 5
      selector:
        number:
          min: 0.1
          max: 25.0
          step: 0.1
          mode: slider
    kI:
      name: I-–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç PID
      description: I (–∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è) - —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
      default: 0
      selector:
        number:
          min: 0.01
          max: 1.0
          step: 0.01
          mode: slider
    kD:
      name: D-–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç PID
      description: D (–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è) - –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –±—É–¥—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      default: 0
      selector:
        number:
          min: 0.01
          max: 10.0
          step: 0.1
          mode: slider


mode: restart
trigger:
  - platform: time_pattern
    seconds: "/10"

variables:
  current_temp: "{{ states( temp_sensor ) | float(0) }}"
  target: "{{ target_temp }}"
  error: "{{ target - current_temp }}"
  prev_error: "{{ states( last_error_var ) | float(0) }}"
  integral: "{{ states( integral_var ) | float(0) + error * 10 }}"   # 10 —Å–µ–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª
  derivative: "{{ (error - prev_error) / 10 }}"
  output: >
    {% set value = (kP * error + kI * integral + kD * derivative) | round(0) %}
    {% if value < 0 %} 0
    {% elif value > 100 %} 100
    {% else %} {{ value }}
    {% endif %}

action:
  - choose:
      # –ê–≤–∞—Ä–∏–π–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä–µ–≤–µ
      - conditions:
          - condition: template
            value_template: "{{ current_temp >= max_temp }}"
        sequence:
          - service: light.turn_off
            target:
              entity_id: "{{ ir_dimmer }}"
          - variables:
              integral: 0  # –°–±—Ä–æ—Å –∏–Ω—Ç–µ–≥—Ä–∞–ª–∞
          - delay: "00:05:00"  # –ü–∞—É–∑–∞ 5 –º–∏–Ω—É—Ç
    
      # –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
      - conditions:
          - condition: template
            value_template: "{{ current_temp < max_temp }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: "{{ ir_dimmer }}"
            data:
              brightness_pct: "{{ pid_output }}"
              
action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ current_temp >= max_temp }}"
        sequence:
          - service: light.turn_off
            target:
              entity_id: !input ir_dimmer
          - service: input_number.set_value
            data:
              entity_id: !input integral_var
              value: 0
          - service: input_number.set_value
            data:
              entity_id: !input last_error_var
              value: 0
          - service: system_log.write
            data:
              level: warning
              message: "üö® PID Thermostat: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {{ current_temp }}¬∞C >= {{ max_temp }}¬∞C ‚Äî –∞–≤–∞—Ä–∏–π–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ."

      - conditions:
          - condition: template
            value_template: "{{ current_temp < max_temp }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input ir_dimmer
            data:
              brightness_pct: "{{ output }}"

          - service: input_number.set_value
            data:
              entity_id: !input integral_var
              value: "{{ integral | round(2) }}"

          - service: input_number.set_value
            data:
              entity_id: !input last_error_var
              value: "{{ error | round(2) }}"

          - service: system_log.write
            data:
              level: info
              message: >
                PID Thermostat: T={{ current_temp }}¬∞C,
                Target={{ target }}¬∞C,
                Error={{ error | round(2) }},
                Out={{ output }}%.