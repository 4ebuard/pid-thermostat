blueprint:
  name: PID-thermostat
  description: >
    ÐŸÐ»Ð°Ð²Ð½Ð¾Ðµ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´Ð¸Ð¼Ð¼ÐµÑ€Ð¾Ð¼ (Ð˜Ðš-Ð»Ð°Ð¼Ð¿Ð¾Ð¹) Ð´Ð»Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹ Ð² Ñ‚ÐµÑ€Ñ€Ð°Ñ€Ð¸ÑƒÐ¼Ðµ.

  domain: automation
  input:
    temp_sensor:
      name: Ð”Ð°Ñ‚Ñ‡Ð¸Ðº Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹
      selector:
        entity:
          domain: sensor
          device_class: temperature

    ir_dimmer:
      name: Ð”Ð¸Ð¼Ð¼ÐµÑ€ (Ð˜Ðš-Ð»Ð°Ð¼Ð¿Ð°)
      selector:
        entity:
          domain: light

    target_temp:
      name: Ð£ÑÑ‚Ð°Ð²ÐºÐ° Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹ (Â°C)
      selector:
        entity:
          domain: input_number

    max_temp:
      name: ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð° (Â°C)
      description: "ÐŸÑ€Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ð¸ ÑÑ‚Ð¾Ð¹ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹ Ð»Ð°Ð¼Ð¿Ð° Ð²Ñ‹ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑÑ"
      default: 42
      selector:
        number:
          min: 30
          max: 60
          step: 0.5

    integral_var:
      name: ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ð»Ð° (input_number)
      selector:
        entity:
          domain: input_number

    last_error_var:
      name: ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ (input_number)
      selector:
        entity:
          domain: input_number

    kP:
      name: P-ÐºÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ PID
      default: 5
      selector:
        number:
          min: 0.1
          max: 25.0
          step: 0.1
          mode: slider

    kI:
      name: I-ÐºÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ PID
      default: 0
      selector:
        number:
          min: 0.01
          max: 1.0
          step: 0.01
          mode: slider

    kD:
      name: D-ÐºÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ PID
      default: 0
      selector:
        number:
          min: 0.01
          max: 10.0
          step: 0.1
          mode: slider

mode: restart

trigger:
  - platform: time_pattern
    seconds: "/10"

variables:
  kP: !input kP
  kI: !input kI
  kD: !input kD

  temp_sensor_entity: !input temp_sensor
  target_temp_entity: !input target_temp
  last_error_entity: !input last_error_var
  integral_entity: !input integral_var
  ir_dimmer_entity: !input ir_dimmer
  max_temp_value: !input max_temp

  current_temp: "{{ states(temp_sensor_entity) | float(0) }}"
  target: "{{ states(target_temp_entity) | float(0) }}"
  error: "{{ (states(target_temp_entity) | float(0)) - (states(temp_sensor_entity) | float(0)) }}"
  prev_error: "{{ states(last_error_entity) | float(0) }}"
  integral: "{{ (states(integral_entity) | float(0)) + error * 10 }}"
  derivative: "{{ (error - prev_error) / 10 }}"

  output: >
    {% set value = (kP * error + kI * integral + kD * derivative) | round(0) %}
    {% if value < 0 %} 0
    {% elif value > 100 %} 100
    {% else %} {{ value }}
    {% endif %}

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ current_temp >= max_temp_value }}"
        sequence:
          - service: light.turn_off
            target:
              entity_id: "{{ ir_dimmer_entity }}"
          - service: input_number.set_value
            data:
              entity_id: "{{ integral_entity }}"
              value: 0
          - service: input_number.set_value
            data:
              entity_id: "{{ last_error_entity }}"
              value: 0
          - service: system_log.write
            data:
              level: warning
              message: "ðŸš¨ PID: ÐŸÐµÑ€ÐµÐ³Ñ€ÐµÐ²! T={{ current_temp }}Â°C >= {{ max_temp_value }}Â°C â€” Ð»Ð°Ð¼Ð¿Ð° Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°."

      - conditions:
          - condition: template
            value_template: "{{ current_temp < max_temp_value }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: "{{ ir_dimmer_entity }}"
            data:
              brightness_pct: "{{ output }}"

          - service: input_number.set_value
            data:
              entity_id: "{{ integral_entity }}"
              value: "{{ integral | round(2) }}"

          - service: input_number.set_value
            data:
              entity_id: "{{ last_error_entity }}"
              value: "{{ error | round(2) }}"

          - service: system_log.write
            data:
              level: info
              message: >
                PID: T={{ current_temp }}Â°C,
                Target={{ target }}Â°C,
                Error={{ error | round(2) }},
                Out={{ output }}%.